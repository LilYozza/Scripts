
local Players=game:GetService("Players")
local Player=game.Players.LocalPlayer

-->Base Variables<--
local Run = game:GetService("RunService")
local CoreGui = game:GetService("CoreGui")

-->Tables<--
ESPFuncTbl={UpdateESP,RemoveESP,CreateESP}
local MyChar = Player.Character

local ESPFolder=CoreGui:FindFirstChild("ESP Stuff")
if not ESPFolder then ESPFolder=Instance.new("Folder",CoreGui)ESPFolder.Name="ESP Stuff"end

local PlayerESP=ESPFolder:FindFirstChild("PlayerESP")
local ItemESP=ESPFolder:FindFirstChild("ItemESP")

if not PlayerESP then PlayerESP=Instance.new("Folder",ESPFolder)PlayerESP.Name="PlayerESP"end
if not ItemESP then ItemESP=Instance.new("Folder",ESPFolder)ItemESP.Name="ItemESP"end

local function FindESP(Obj)
	for i, v in next, ItemESP:GetChildren() do
		if v.className == "ObjectValue" then
			if v.Value == Obj then
				return v.Parent
			end
		end
	end

	return nil
end

ESPFuncTbl.UpdateESP=function(Plr)
	if Plr ~= nil then
		local Find = PlayerESP:FindFirstChild("ESP Crap_" .. Plr.Name)
		if Find then
			local PickColor = Color3.new(255,0,0)
			Find.Frame.Names.TextColor3 = PickColor
			Find.Frame.Dist.TextColor3 = PickColor
			Find.Frame.Health.TextColor3 = PickColor
			--Find.Frame.Pos.TextColor3 = PickColor
			local GetChar = Plr.Character
			if MyChar and GetChar then
				local Find2 = MyChar:FindFirstChild("HumanoidRootPart")
				local Find3 = GetChar:FindFirstChild("HumanoidRootPart")
				local Find4 = GetChar:FindFirstChildOfClass("Humanoid")
				if Find2 and Find3 then
					local pos = Find3.Position
					local Dist = (Find2.Position - pos).magnitude
					if Dist > 2048 then
						Find.Frame.Names.Visible = false
						Find.Frame.Dist.Visible = false
						Find.Frame.Health.Visible = false
						return
					else
						Find.Frame.Names.Visible = true
						Find.Frame.Dist.Visible = true
						Find.Frame.Health.Visible = true
					end
					Find.Frame.Dist.Text = "Distance: " .. string.format("%.0f", Dist)
					--Find.Frame.Pos.Text = "(X: " .. string.format("%.0f", pos.X) .. ", Y: " .. string.format("%.0f", pos.Y) .. ", Z: " .. string.format("%.0f", pos.Z) .. ")"
					if Find4 then
						Find.Frame.Health.Text = "Health: " .. string.format("%.0f", Find4.Health)
					else
						Find.Frame.Health.Text = ""
					end
				end
			end
		end
	end
end

ESPFuncTbl.RemoveESP=function(Obj)
	if Obj ~= nil then
		local IsPlr = Obj:IsA("Player")
		local UseFolder = ItemESP
		if IsPlr then UseFolder = PlayerESP end

		local FindESP = ((IsPlr) and UseFolder:FindFirstChild("ESP Crap_" .. Obj.Name)) or FindESP(Obj)
		if FindESP then
			FindESP:Destroy()
		end
	end
end

ESPFuncTbl.CreateESP=function(Obj)
	if Obj ~= nil then
		local IsPlr = Obj:IsA("Player")
		local UseFolder = ItemESP
		local GetChar = ((IsPlr) and Obj.Character) or Obj
		local Head = GetChar:FindFirstChild("Head")
		local t = tick()
		if IsPlr then UseFolder = PlayerESP end
		if Head == nil then
			repeat
				Head = GetChar:FindFirstChild("Head")
				wait()
			until Head ~= nil or (tick() - t) >= 10
		end
		if Head == nil then return end
		
		local bb = Instance.new("BillboardGui")
		bb.Adornee = Head
		bb.ExtentsOffset = Vector3.new(0, 1, 0)
		bb.AlwaysOnTop = true
		bb.Size = UDim2.new(0, 5, 0, 5)
		bb.StudsOffset = Vector3.new(0, 3, 0)
		bb.Name = "ESP Crap_" .. Obj.Name
		bb.Parent = UseFolder
		
		local frame = Instance.new("Frame", bb)
		frame.ZIndex = 10
		frame.BackgroundTransparency = 1
		frame.Size = UDim2.new(1, 0, 1, 0)
		
		local TxtName = Instance.new("TextLabel", frame)
		TxtName.Name = "Names"
		TxtName.ZIndex = 10
		TxtName.Text = Obj.Name
		TxtName.BackgroundTransparency = 1
		TxtName.Position = UDim2.new(0, 0, 0, -45)
		TxtName.Size = UDim2.new(1, 0, 10, 0)
		TxtName.Font = "SourceSansBold"
		TxtName.TextSize = 13
		TxtName.TextStrokeTransparency = 0.5

		local TxtDist = nil
		local TxtHealth = nil
		if IsPlr then
			TxtDist = Instance.new("TextLabel", frame)
			TxtDist.Name = "Dist"
			TxtDist.ZIndex = 10
			TxtDist.Text = ""
			TxtDist.BackgroundTransparency = 1
			TxtDist.Position = UDim2.new(0, 0, 0, -35)
			TxtDist.Size = UDim2.new(1, 0, 10, 0)
			TxtDist.Font = "SourceSansBold"
			TxtDist.TextSize = 13
			TxtDist.TextStrokeTransparency = 0.5

			TxtHealth = Instance.new("TextLabel", frame)
			TxtHealth.Name = "Health"
			TxtHealth.ZIndex = 10
			TxtHealth.Text = ""
			TxtHealth.BackgroundTransparency = 1
			TxtHealth.Position = UDim2.new(0, 0, 0, -25)
			TxtHealth.Size = UDim2.new(1, 0, 10, 0)
			TxtHealth.Font = "SourceSansBold"
			TxtHealth.TextSize = 13
			TxtHealth.TextStrokeTransparency = 0.5
		else
			local ObjVal = Instance.new("ObjectValue", bb)
			ObjVal.Value = Obj
		end
		
		local PickColor = Color3.new(255,0,0)
		TxtName.TextColor3 = PickColor

		if IsPlr then
			TxtDist.TextColor3 = PickColor
			TxtHealth.TextColor3 = PickColor
		end
	end
end


--[[
local isESP
    spawn(function()
        local s,e=pcall(function()
            for _,v in pairs(game.Players:GetChildren())do
                if v~=game.Players.LocalPlayer then
                    PlayerConnections[_]=v.CharacterAdded:Connect(function()
                        if isESP then
                            RemoveESP(player)
                            CreateESP(player)
                            end
                    end)
                    if isESP then RemoveESP(v)CreateESP(v)
                    else
                        for _,v in pairs(PlayerConnections)do
                            if v then v:Disconnect()end
                        end
                        RemoveESP(v)
                    end
                end
            end
        end)if not s then print(e)end
    end)


if not SpawnPCon then
    SpawnPCon = Players.PlayerAdded:Connect(function(player)
        player.CharacterAdded:Connect(function()
            if isESP and player then
                repeat task.wait()until player.Character:FindFirstChild("HumanoidRootPart") and player.Character:FindFirstChild("Head")
                RemoveESP(player)
                CreateESP(player)
                print("Added ESP On:",player)
            end
        end)
    end)
end

if not DespawnPCon then
    DespawnPCon=game.Players.PlayerRemoving:Connect(function(plr)
        RemoveESP(plr)
    end)
end

local succ, out = coroutine.resume(coroutine.create(function()
    while true do
        for _, v in next, Players:GetPlayers() do
            UpdateESP(v)
            Run.RenderStepped:wait()
        end
    end
end))

--]]
