--[[
    Save Structure

    {
        [Label Name] = {
            var = "Gobal Var Name",
            val = "Value"
        }
    
    }

    Functions
    - LoadManager() -- Find / Loads any config for that gameplace
    - SaveManager(_data) -- Loads and Saves Data

]]
local path = "YozzaScriptHub/" .. game.gameId .. ".json"

local Players = game:GetService("Players")
local CoreGui = game:GetService("CoreGui")
local HttpService = game:GetService("HttpService")

local Player = Players.LocalPlayer

local function getGui()
    for _,v in pairs(CoreGui:GetChildren()) do
        local fnd = v:FindFirstChild("HiI'mSexyDon'tTouchMePls")
        if fnd then return v end
    end
end

local function getWindow(_gui, _name)
    _gui = _gui or getGui()
    _name = _name or "Main"
    for _,v in pairs(_gui:GetChildren()) do
        local title = v:FindFirstChild("Title")
        if title and title:IsA("TextLabel") and title.Text == _name then
            return v
        end
    end
end

local function getItems(_window)
    local t = {}
    _window = _window or getWindow()
    local sectionsFolder = _window:FindFirstChild("Sections")
    if not sectionsFolder then return t end

    -- Loop through all first-level folders in Sections
    for _, section in pairs(sectionsFolder:GetChildren()) do
        -- Each section might have nested Folders leading to Content
        local contentFolder = section:FindFirstChild("Folder")
        while contentFolder and contentFolder:FindFirstChild("Folder") do
            contentFolder = contentFolder.Folder
        end

        if contentFolder and contentFolder:FindFirstChild("Content") then
            for _, v in pairs(contentFolder.Content:GetChildren()) do
                if v:IsA("ImageLabel") then
                    local Type = v.Name
                    local Title = (v:FindFirstChild("Title") and v.Title.Text)
                        or (v:FindFirstChild("Click") and v.Click:FindFirstChild("Title") and v.Click.Title.Text)
                    local Button = v:FindFirstChild("Tick") or v:FindFirstChild("Button")
                    local Input = v:FindFirstChild("Input")
                    t[Title] = {Type = Type, Title = Title, Button = Button, Input = Input}
                end
            end
        end
    end

    return t
end

local function updateTable(_tbl)
    for _, v in pairs(_tbl) do
        if shared[v.var] then
            v.val = shared[v.var]
        end
    end
end

local function saveFile(_tbl, _path)
    if not _tbl or next(_tbl) == nil then return end -- Check if table is nil or empty
    updateTable(_tbl) -- Gets the Vars of toggles


    local s,e = pcall(function()
        local jsonString = HttpService:JSONEncode(_tbl)
        writefile(_path, jsonString)
    end)

    if s then
        --print("Saved Data For", game.gameId)
    else
        warn("Couldnt Save File:", e)
    end
end

local function loadFile(_path)
    local decodedData
    local s, e = pcall(function()
        local contents = readfile(_path)
        decodedData = HttpService:JSONDecode(contents)
    end)
    if s then
        return decodedData
    else
        warn("Couldn't Load File:", e)
    end
end

getgenv().LoadManager = function(_override)
    if isfile(path) then
        -- Read In txt File
        local content = loadFile(path)
        if content then

            -- WAIT FOR UI
            repeat task.wait() until getGui()
            task.wait(1)

            local items = getItems()
            for _,v in pairs(content) do
                if items[_] then
                    local item = items[_]
                    if item.Type == "Toggle" and v.val and v.val == true then -- UI CHANGES, ADD OTHERES HERE
                        SendClick(item.Button) -- Toggles Gui
                    elseif item.Type == "Slider" and v.val then
                        item.Input.Value.Text = v.val
                        shared[v.var] = v.val
                    end
                end
            end
        end

        print("Loaded Save File For", game.gameId, path)
    else
        print("No Save File For:", game.gameId, path)
        --writefile(path, game.gameId .. ".txt")
    end


end

getgenv().SaveManager = function(_tbl)
    local saved = false
    LoadManager() -- Apply any saved values first

    local function triggerSave()
        if not saved then
            saveFile(_tbl, path)
            saved = true
        end
    end

    -- Fires when the player leaves
    Players.PlayerRemoving:Connect(function(player)
        if player == Player then
            triggerSave()
        end
    end)

    -- Fires if the player object is removed from hierarchy
    Player.AncestryChanged:Connect(function(_, parent)
        if not parent then
            triggerSave()
        end
    end)

    -- Periodic autosave every 60 seconds
    task.spawn(function()
        while task.wait(60) do
            saved = false  -- allow re-save
            triggerSave()
        end
    end)
end